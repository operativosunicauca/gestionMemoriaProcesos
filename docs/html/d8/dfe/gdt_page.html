<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Proyecto 10 - Gestión de Memoria Física: Tabla Global de Descriptores - GDT</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Proyecto 10 - Gestión de Memoria Física
   &#160;<span id="projectnumber">0.9</span>
   </div>
   <div id="projectbrief">Aprendiendo Sistemas Operativos</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generado por Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Buscar');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Página&#160;principal</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Páginas&#160;relacionadas</span></a></li>
      <li><a href="../../modules.html"><span>Módulos</span></a></li>
      <li><a href="../../annotated.html"><span>Estructuras&#160;de&#160;Datos</span></a></li>
      <li><a href="../../files.html"><span>Archivos</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Buscar" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Todo</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Estructuras de Datos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Archivos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Funciones</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>&apos;typedefs&apos;</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>&apos;defines&apos;</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Grupos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Páginas</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Tabla Global de Descriptores - GDT </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Autor</dt><dd>Erwin Meza Vega <a href="#" onclick="location.href='mai'+'lto:'+'eme'+'za'+'v@g'+'ma'+'il.'+'co'+'m'; return false;">emeza<span style="display: none;">.nosp@m.</span>v@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></dd></dl>
<p><a class="el" href="../../index.html#project_start">Información del Proyecto</a> : <a class="el" href="../../d8/d50/ia32_intro.html">Programación de procesadores de arquitectura IA-32</a> : GDT</p>
<p>La GDT es una tabla que usa el procesador cuando se encuentra en modo protegido para traducir direcciones lógicas a direcciones lineales de memoria. Si la paginación se encuentra deshabilitada, la dirección lineal hallada se toma como una dirección física directamente.</p>
<dl class="section note"><dt>Nota</dt><dd>Antes de pasar a modo protegido, se debe configurar una GDT que contenga al menos dos descriptores: un descriptor de segmento de código y un descriptor de segmento de datos.</dd></dl>
<h1><a class="anchor" id="segment_descriptors"></a>
Descriptores de segmento</h1>
<p>La GDT está compuesta por uno o más descriptores de segmento. Cada descriptor de segmento es una estructura de datos que contiene información de la ubicación de un segmento en memoria, su tipo y algunas opciones de protección.</p>
<p>Un descriptor de segmento ocupa 8 bytes (64 bits), distribuidos de la siguiente forma:</p>
<pre class="fragment">     Descriptor de Segmento

31                23                15                7                   0
+-----------------+-----------------+-----------------------------------+
|                 | |D| |A|         | |     | |       |                 |
| BASE 24..31     |G|/|L|V| LIMIT   |P| DPL |S| TYPE  | BASE 16..23  | 4
|                 | |B| |L| 16..19  | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
| SEGMENT BASE 0..15                | SEGMENT LIMIT 0..15               | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+</pre><p>En el Manual de Intel Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 3A: System Programming Guide, Part 1 (pág 95) describe cada uno de los campos de un descriptor. A continuación se presenta una breve reseña de estos campos.</p>
<ul>
<li>Limit (20 bits): Define el tamaño del segmento. Para calcular el tamaño en bytes de un segmento se toma el valor de Límite y se verifica el bit G (Granularidad). Si G = 0, el valor de límite se expresa en bytes. Si G = 1, el valor de límite expresa en unidades de memoria de 4 KB. De esta forma, el máximo tamaño de un segmento, si todos los bits de Límite se encuentran en 1 y el bit G se encuentra en 1 es de 4 GB (2 ^ 20 * 4 KB = 2 ^ 20 * 2 ^ 12 bytes = 2 ^ 32 = 4 GB). Los bits que conforman el valor de Limit se encuentran dispersos dentro del descriptor.</li>
<li>Base (32 bits): Define la dirección lineal en la cual inicia el segmento en el espacio lineal de direcciones. Dado que se dispone de 32 bits para Base, el segmento puede empezar en cualquier dirección en el espacio lineal. Los bits que conforman el valor de Base se encuentran dispersos dentro del descriptor.</li>
<li>Type: Permite especificar el tipo de segmento y especifica los tipos de acceso permitidos. Por ejemplo, se puede definir un segmento de datos de sólo lectura o un segmento de datos de lectura / escritura.</li>
<li>S: Determina el tipo de descriptor de segmento. Si el descriptor es para un segmento de código o datos, S = 1. Si el descriptor es de otro tipo (descriptor del sistema), S = 0.</li>
<li>DPL: Especifica el nivel de privilegios del segmento. Debido a que sólo se tienen 2 bits para DPL, los privilegios válidos son 0, 1 2 y 3. El nivel de mayor privilegios es 0.</li>
<li>P: Permite verificar si el segmento está presente en memoria (P = 1) o no (P = 0)</li>
<li>AVL: Este bit se encuentra disponible para uso del sistema.</li>
<li>L: Este bit debe ser cero para procesadores de 32 bits. Sólo se usa en procesadores de 63 bits, y permite definir que se está describiendo un segmento de código de 64 bits.</li>
<li>D/B — Default operation size: Permite definir el tamaño de operando por defecto del segmento. Para segmentos de código y datos de 32 bits este bit se deberá establecer en 1, mientras que para segmentos de 16 bits se deberá establecer en 0.</li>
</ul>
<h1><a class="anchor" id="gdt_selectors"></a>
Selectores</h1>
<p>Los descriptores que se almacenan en la GDT se referencian a través de <b>Selectores</b>. Estos permiten establecer la posición (el índice) en la cual se encuentra en descriptor de segmento, la Tabla de Descriptores en la cual se encuentra y los privilegios de acceso.</p>
<pre class="fragment">            Selector
                                       LDT / GDT                                     
   15           3 2 1 0   
   +-------------+-+--+         +------------------------+
   |             | |R |         |                        |
   | INDEX       |T|P |         |     ....               |
   |             |I|L |         |                        |
   +-------------+-+--+         |                        |
         |                      +------------------------+
         |                      |     |     |      |     |
         +---------------------&gt;|------------------------|
                                |           |            |
                                +------------------------+
                                |     |     |      |     |
                                |------------------------|
                                |           |            |
                                +------------------------+</pre><p> En donde:</p>
<ul>
<li>INDEX : Posición en la tabla en la cual se encuentra el descriptor.</li>
<li>TI (Table Indicator) : Indicador de tabla dentro de la cual se debe buscar el descriptor (0 = GDT, 1 = LDT)</li>
<li>RPL ( Requestor Privilege Level ) : Nivel de privilegios del solicitante.</li>
</ul>
<p>En modo protegido de 32 bits, la primera entrada de la GDT es nula. Así, si un selector (registro de segmento) puede tomar el valor de 0 para indicar que no ha sido configurado.</p>
<p>La LDT es similar en formato a la GDT, pero se diferencia en:</p>
<ul>
<li>Es usada por una tarea para gestionar sus segmentos</li>
<li>Si primera entrada, a diferencia de la GDT sí puede ser utilizada.</li>
<li>Si una tarea tiene definida su GDT, debe existir una entrada dentro de la GDT que describa la LDT.</li>
</ul>
<h1><a class="anchor" id="address_translation"></a>
Direcciones lógicas en Modo Real y Modo Protegido</h1>
<p>Si importar su modo de operación, los procesadores IA-32 usan siempre direcciones lógicas que se obtienen al combinar dos tipos de registros:</p>
<ul>
<li>Un registro de segmento (CS, DS, ES, FS, GS y SS)</li>
<li>Un registro de propósito general, ESB, EBP, EIP o un valor inmediato, dependiendo de la instrucciÓn.</li>
</ul>
<p>Por ejemplo: CS:EIP, DS:SI, ES:DI.</p>
<p>Estas direcciones lógicas de memoria se transforman en direcciones lineales de formas diferentes en modo real y modo protegido:</p>
<p>En modo real, los registros de segmento (CS, DS, ES, FS, GS y SS) almacenan la dirección base del segmento dividida en 16. El registro de propósito general contiene el desplazamiento a partir de la dirección base del segmento.</p>
<p>La dirección lineal se calcula de la siguiente forma:</p>
<p>dir. lineal = segmento x 16 + offset</p>
<p>En modo protegido, los registros de segmento (CS, DS, ES, FS, GS y SS) almacenan el selector que referencia a un descriptor de segmento dentro de la GDT o la LDT. El registro de propósito general contiene el desplazamiento a partir de la dirección base del segmento.</p>
<p>Para calcular una dirección lineal se realiza el siguiente proceso:</p>
<ol type="1">
<li>Con el atributo TI del selector, se determina si el descriptor de segmento se buscará en la GDT o la LDT (GDT por defecto).</li>
<li>Con el atributo RPL se determina si se tiene permiso para acceder al descriptor.</li>
<li>Con el atributo INDEX del selector, se busca el descriptor correspondiente en la tabla especificada.</li>
<li>Del descriptor se obtiene la dirección base del segmento, la cual se suma al desplazamiento para obtener la dirección lineal.</li>
</ol>
<p>Gráficamente la traducción de una dirección lógica a una dirección lineal en modo protegido se realiza de la siguiente forma:</p>
<pre class="fragment">     DIRECCIÓN LÓGICA
     
  Selector (Inmediato o                 Desplazamiento
        en un registro de segmento)       (Inmediato o en un registro de
    15                             0 31     segmento)                         0
    +--------------------+-------+-+ +----------------------------------------+
    |  INDEX (Índice     | DPL   |T| |                                        |
    |  dentro de la Tabla|(0 a 3)|I| |          OFFSET                        |
    |  de Descriptores)  |       | | |                                        |
    +--------------------+-------+-+ +----------------------------------------+
            |                     |                      |
    +-------+                     |                      |
    |   Tabla de                  v                      |
    |   Descriptores          (0=GDT), (1=LDT)           |
    |  +--------------------+                            |
    |  |                    |                            |
    |  |                    |                            |
    |  |                    |                            |
    |  |                    |                            |
    |  +--------------------+                            |
    |  | Descriptor de      |  Dir. Base    +---+ Offset |
    +-&gt;| Segmento           |--------------&gt;| + |&lt;-------+
       +--------------------+ del Segmento  +---+
       |                    |                 |
    +-&gt;+--------------------+                 | 
    |                           31            V                            0
    |                           +------------------------------------------+
    +-------+                   |        Dirección Lineal                  |
            |                   +------------------------------------------+
            |
            |                   
 47         |           15          0  
 +----------------------+-----------+  
 | Base                 |  Límite   |   &lt;- GDTR
 +----------------------+-----------+  </pre><dl class="section user"><dt>Ejemplos de GDT</dt><dd></dd></dl>
<p>Como se mencionó anteriormente, antes de habilitar el modo protegido del procesador es necesario configurar y cargar la GDT. A continuación se presenta el contenido de una GDT, suponiendo que se definen los segmentos de código y datos para el kernel en modo plano (flat) con nivel de privilegios 0.</p>
<p>Para este caso, la GDT contiene tres entradas (tres descriptores de segmento):</p>
<ul>
<li>El primer descriptor es nulo (todos sus campos son cero). Requerido por la arquitectura IA-32.</li>
<li>El segundo descriptor se usa para describir el segmento de código del kernel, con los siguientes parámetros:<ul>
<li>Base: 0 = 0x00000000</li>
<li>Límite: 4 GB = 0xFFFFF, Bit G = 1</li>
<li>Nivel de Privilegios: 0</li>
<li>Tipo de Segmento: Código, Lectura / Ejecución</li>
</ul>
</li>
<li>El tercer descriptor se usa para describir el segmento de datos del kernel, con los siguientes parámetros:<ul>
<li>Base: 0 = 0x00000000</li>
<li>Límite: 4 GB = 0xFFFFF, Bit G = 1</li>
<li>Nivel de Privilegios: 0</li>
<li>Tipo de Segmento: Datos, Lectura / Escritura</li>
</ul>
</li>
</ul>
<p>El orden de los descriptores (después del primero) puede ser cualquiera, aunque generalmente se define primero el descriptor de segmento de datos y luego el descriptor de segmento de código.</p>
<p>A continuación se muestra el contenido de los tres descriptores de segmento.</p>
<ul>
<li>Descriptor de segmento nulo: <pre class="fragment"> Descriptor nulo (Primera entrada de la GDT)
 
 
+-----------------+-----------------+-----------------------------------+
|                 | |D| |A|         | |     | |       |                 |
| BASE 24..31     |G|/|L|V| LIMIT   |P| DPL |S| TYPE  | BASE 16..23  | 4
|                 | |B| |L| 16..19  | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
| SEGMENT BASE 0..15                | SEGMENT LIMIT 0..15               | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+
 
 31                23                15                7                  0
+-----------------+-----------------+-----------------------------------+
|                 | | | | |         | |     | |       |                 |
| 0 0 0 0 0 0 0 0 |0|0|0|0| 0 0 0 0 |0| 0 0 |0|0 0 0 0| 0 0 0 0 0 0 0 0 | 4
|                 | | | | |         | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
|  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0  |  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0  | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+</pre><ul>
<li>El selector correspondiente a este descriptor es: <pre class="fragment">         15           3 2 1 0 
         +-------------+-+--+
         |0000000000000|0|00|   Selector Nulo = 0x00  
         +-------------+-+--+   Índice = 0, TI = 0 (GDT), DPL = 0x00</pre></li>
</ul>
</li>
<li>Descriptor de segmento de código: <pre class="fragment"> Descriptor de Segmento de Código (Segunda entrada en la GDT)
 
 +-----------------+-----------------+-----------------------------------+
|                 | |D| |A|         | |     | |       |                 |
| BASE 24..31     |G|/|L|V| LIMIT   |P| DPL |S| TYPE  | BASE 16..23  | 4
|                 | |B| |L| 16..19  | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
| SEGMENT BASE 0..15                | SEGMENT LIMIT 0..15               | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+
 
 31                23                15                7                  0
+-----------------+-----------------+-----------------------------------+
|                 | | | | |         | |     | |       |                 |
| 1 1 1 1 1 1 1 1 |1|1|0|0| 1 1 1 1 |1| 0 0 |1|1 0 1 0| 1 1 1 1 1 1 1 1 | 4
|                 | | | | |         | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
|  1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  |  1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+
 
 Observe que el campo Type tiene valor 1010, definido en el manual de
 Intel como Segmento de Código, Lectura y Ejecución. Consulte la tabla 3-1
 en ese documento.</pre><ul>
<li>El selector correspondiente a este descriptor es: <pre class="fragment">         15           3 2 1 0 
         +-------------+-+--+
         |0000000000001|0|00|   Selector de Código: 1000 = 0x08
         +-------------+-+--+   Índice = 0, TI = 0 (GDT), DPL = 0x00</pre></li>
</ul>
</li>
<li>Descriptor de segmento de datos: <pre class="fragment"> Descriptor de Segmento de Datos (Tercera entrada en la GDT)
 
 +-----------------+-----------------+-----------------------------------+
|                 | |D| |A|         | |     | |       |                 |
| BASE 24..31     |G|/|L|V| LIMIT   |P| DPL |S| TYPE  | BASE 16..23  | 4
|                 | |B| |L| 16..19  | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
| SEGMENT BASE 0..15                | SEGMENT LIMIT 0..15               | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+
 
 31                23                15                7                  0
+-----------------+-----------------+-----------------------------------+
|                 | | | | |         | |     | |       |                 |
| 1 1 1 1 1 1 1 1 |1|1|0|0| 1 1 1 1 |1| 0 0 |1|0 0 1 0| 1 1 1 1 1 1 1 1 | 4
|                 | | | | |         | |     | |       |                 |
|-----------------------------------+-----------------------------------+
|                                   |                                   |
|  1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  |  1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  | 0
|                                   |                                   |
+-----------------+-----------------+-----------------+-----------------+     
 
 Observe que el campo Type tiene valor 0010, definido en el manual de
 Intel como Segmento de Datos, Lectura y Escritura. Consulte la tabla 3-1
 en ese documento.</pre><ul>
<li>El selector correspondiente a este descriptor es: <pre class="fragment">         15           3 2 1 0 
         +-------------+-+--+
         |0000000000010|0|00|   Selector de Código: 10000 = 0x10
         +-------------+-+--+   Índice = 2, TI = 0 (GDT), DPL = 0x00</pre></li>
</ul>
</li>
</ul>
<dl class="section user"><dt>Representación de la GDT en Lenguaje Ensamblador</dt><dd></dd></dl>
<p>La GDT no es más que un arreglo o secuencia de descriptores, uno tras de otros en memoria. Por lo tanto, puede ser expresada en lenguaje ensamblador de la siguiente forma:</p>
<pre class="fragment">gdt:
    /* La primera entrada del gdt debe ser nula */
   .word 0x0000
   .word 0x0000
   .byte 0x00
   .byte 0x00
   .byte 0x00
   .byte 0x00

   .word 0xFFFF  /* Limite 0..15 = FFFF */
   .word 0x0000  /* Base 0..15 = 0000 */
   .byte 0x00    /* Base 16..23 = 00 */
   .byte 0x9A    /* 10011010 P=1, DPL=0, S=1, Tipo: codigo, read/execute,
         non conforming */
   .byte 0xCF /* 11001111 G=1, D/B=1 (32 bits), L=0, AVL=0, Limite 16..19=F */
   .byte 0x00 /* Base 24..31 = 00 */

   .word 0xFFFF  /*Limite 0..15 = FFFF */
   .word 0x0000  /*Base 0..15 = 0000 */
   .byte 0x00    /*Base 16..23 = 00 */
   .byte 0x92  /*10010010 P=1, DPL=0, S=1, Tipo: datos, read/write */
   .byte 0xCF /*11001111  G=1, D/B=1 (32 bits) , L=0, AVL=0, Limite 16..19=F  */
   .byte 0x00  /*Base 24..31 = 00  */</pre><dl class="section user"><dt>Representación de la GDT en lenguaje C</dt><dd></dd></dl>
<p>En Lenguaje C es necesario definir una estructura de datos que agrupe los campos de un descriptor de segmento, y luego un arreglo que contenga descriptores. Existe muchas representaciones diferentes, a continuación se muestran algunos ejemplos:</p>
<ol type="1">
<li>Una representación de descriptor de segmento en la cual se usan enteros de 32 bits: <pre class="fragment">struct gdt_descriptor {
 /* Bits menos significativos del descriptor. Agrupan
  * Limite 0..15 y Base 0..15 del descriptor */
  unsigned int low : 32;
  /* Bits más significativos del descriptor. Agrupan Base 16..23, Tipo,
   * S, DPL, P, Límite, AVL, L, D/B, G y Base 24..31 */
  unsigned int high: 32;
}__attribute__((packed));

/* Definición de la GDT */
struct gdt[MAX_GDT_ENTRIES] __attribute__((aligned(8))); </pre> La documentación de IA-32 exige que la GDT se encuentre alineada a un límite de 8 bytes. Para esta representación de descriptores de segmento el código de inicialización puede ser el siguiente: <pre class="fragment">   /* Inicializar la primera entrada en nulo*/
   gdt[0].low = 0;
   gdt[0].high = 0;
   
   /* Inicializar la segunda entrada con un descriptor de segmento de
      código flat, nivel de privilegios 0 */
   gdt[1].low = 0x0000FFFF;
   gdt[1].high = 0x00CF9A00; 
   
   /* Inicializar la tercera entrada con un descriptor de segmento de datos
   flat, nivel de privilegios 0 */
   gdt[2].low = 0x0000FFFF;
   gdt[2].high = 0x00CF9200;   
</pre></li>
<li>Una representación de descriptor de segmento en la cual los campos se especifican y se acceden por separado: <pre class="fragment">struct gdt_descriptor {
 unsigned limit_low   : 16, /* limite 0..15*/
       base_low   : 16, /* base 0..15 */
       base_middle  : 8,  /* base 16..23*/
       type     : 4,  /* Informacion de acceso */
       code_or_data  : 1, /* 1 = codigo o datos, 0 = sistema */
       dpl    : 2, /* Nivel de privilegio */
       present   : 1, /* Presente */
       limit_high   : 4, /* limite 16..19*/
       available   : 1, /* Disponible */
       l           : 1, /* Reservado */
       db    : 1, /* 0 = 16 bits, 1 = 32 bits */
       granularity  : 1, /* 0 = bytes, 1 = 4096 bytes */
       base_high   : 8; /* base 24..31*/
}__attribute__((packed)); /* Evitar posible alineacion del compilador */


/* Definición de la GDT */
struct gdt_descriptor gdt[MAX_GDT_ENTRIES] __attribute__((aligned(8)));</pre> Para esta representación de descriptores de segmento el código de inicialización puede ser el siguiente: <pre class="fragment">   /* Inicializar la primera entrada en nulo*/
   gdt[0].limit_low = 0x0000;   /* limite 0..15*/
   gdt[0].base_low = 0x0000;    /* base 0..15 */
   gdt[0].base_middle = 0x00;   /* base 16..23 */
   gdt[0].type = 0x0;           /* Informacion de acceso */
   gdt[0].code_or_data = 0;     /* 1 = codigo o datos, 0 = sistema */
   gdt[0].dpl = 0;              /* Nivel de privilegio */
   gdt[0].present = 0;          /* Presente */
   gdt[0].limit_high = 0x0;     /* limite 16..19*/
   gdt[0].available = 0;        /* Disponible */
   gdt[0].l = 0;                /* Reservado */
   gdt[0].db = 0;               /* 0 = 16 bits, 1 = 32 bits */
   gdt[0].granularity = 0;      /* 0 = bytes, 1 = 4096 bytes */
   gdt[0].base_high= 0x00;      /* base 24..31*/
    
   /* Inicializar la segunda entrada con un descriptor de segmento de
      código flat, nivel de privilegios 0 */
   gdt[1].limit_low = 0xFFFF    /* limite 0..15*/
   gdt[1].base_low = 0x0000;    /* base 0..15 */
   gdt[1].base_middle = 0x00;   /* base 16..23 */
   gdt[1].type = 0xA;           /* Informacion de acceso: Código, R/X */
   gdt[1].code_or_data = 1;     /* 1 = codigo o datos, 0 = sistema */
   gdt[1].dpl = 0;              /* Nivel de privilegio */
   gdt[1].present = 1;          /* Presente */
   gdt[1].limit_high = 0xF;       /* limite 16..19*/
   gdt[1].available = 0;        /* Disponible */
   gdt[1].l = 0;                /* Reservado */
   gdt[1].db = 1;               /* 0 = 16 bits, 1 = 32 bits */
   gdt[1].granularity = 1;      /* 0 = bytes, 1 = 4096 bytes */
   gdt[1].base_high= 0;         /* base 24..31*/
   
   /* Inicializar la tercera entrada con un descriptor de segmento de datos
   flat, nivel de privilegios 0 */
   gdt[2].limit_low = 0xFFFF    /* limite 0..15*/
   gdt[2].base_low = 0x0000;    /* base 0..15 */
   gdt[2].base_middle = 0x00;   /* base 16..23 */
   gdt[2].type = 0x2;           /* Informacion de acceso: Datos, R/W */
   gdt[2].code_or_data = 1;     /* 1 = codigo o datos, 0 = sistema */
   gdt[2].dpl = 0;              /* Nivel de privilegio */
   gdt[2].present = 1;          /* Presente */
   gdt[2].limit_high = 0xF;     /* limite 16..19*/
   gdt[2].available = 0;        /* Disponible */
   gdt[2].l = 0;                /* Reservado */
   gdt[2].db = 1;               /* 0 = 16 bits, 1 = 32 bits */
   gdt[2].granularity = 1;      /* 0 = bytes, 1 = 4096 bytes */
   gdt[2].base_high= 0;         /* base 24..31*/ 
</pre></li>
</ol>
<dl class="section user"><dt>Carga de la GDT</dt><dd></dd></dl>
<p>Para cargar la GDT se utiliza la instrucción de ensamblador </p>
<div class="fragment"><div class="line">lgdt ptr_addr</div>
</div><!-- fragment --><p>La instrucción lgdt toma el puntero y lo carga en el registro GDTR del procesador. Así, la traduccion de direcciones lógicas a direcciones físicas se realiza por hardware.</p>
<p>ptr_addr corresponde a la dirección de memoria en la cual se encuentra una estructura de datos que describe la GDT. Esta estructura de datos se denomina 'puntero al GDT', 'GDT Pointer'.</p>
<p>El puntero al GDT tiene el siguiente formato: </p>
<pre class="fragment"> 47                  15              0
 +----------------------------------+
 |      base         |    límite    |
 +----------------------------------+</pre><p> en donde: base = dirección lineal del gdt, que corresponde a la direccion de memoria de GDT.</p>
<p>límite = tamaño de la GDT - 1.</p>
<p>Una vez que se ha cargado la GDT, se debe "pasar" nuevamente a modo protegido, estableciendo el bit 0 (PE) del registro CR0.</p>
<p>Después se debe realizar un far jmp (ljmp) usando un selector que haga referencia a un descriptor de segmento de código configurado en la GDT. Esto se puede lograr mediante una instrucción</p>
<div class="fragment"><div class="line">ljmp sel : offset.</div>
</div><!-- fragment --><p>También se puede lograr mediante una instrucción iret, para simular un retorno de interrupción, almacenando antes en la pila los valores de EFLAGS, CS e IP adecuados para apuntar a una instrucción dentro de un segmento de código definido en la GDT. Este proceso se muestra a continuación:</p>
<div class="fragment"><div class="line">push FLAGS_VAL</div>
<div class="line">push SELECTOR_VAL</div>
<div class="line">push OFFSET_VAL</div>
<div class="line">iret</div>
</div><!-- fragment --><p>En donde FLAGS_VAL será el valor del registro EFLAGS luego de retornar de la interrupción, SELECTOR_VAL deberá ser un selector que referencia a un descriptor de segmento de código configurado en la GDT, y OFFSET_VAL deberá ser el desplazamiento dentro del segmento de código en el cual se desea continuar la ejecución del kernel.</p>
<p>Finalmente se deben configurar los demás registros de segmento (DS, ES, FS, GS y SS) para que contengan los selectores a descriptores de segmento de datos configurados dentro de la GDT.</p>
<p>Al ejecutar estos pasos, el procesador estará usando la GDT configurada. En caso de cualquier error, el procesador lanzará una excepción de protección general y se reiniciará. Si esto pasa, se debe verificar que los descriptores dentro de la GDT se encuentren bien definidos, y que los valores de los selectores almacenados en los registros de segmento hagan referencia a descriptores válidos dentro de la GDT. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generado por &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
