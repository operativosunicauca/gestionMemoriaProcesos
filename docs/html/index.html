<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Proyecto 10 - Gestión de Memoria Física: Gestión de Memoria Física</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Proyecto 10 - Gestión de Memoria Física
   &#160;<span id="projectnumber">0.9</span>
   </div>
   <div id="projectbrief">Aprendiendo Sistemas Operativos</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generado por Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Buscar');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Página&#160;principal</span></a></li>
      <li><a href="pages.html"><span>Páginas&#160;relacionadas</span></a></li>
      <li><a href="modules.html"><span>Módulos</span></a></li>
      <li><a href="annotated.html"><span>Estructuras&#160;de&#160;Datos</span></a></li>
      <li><a href="files.html"><span>Archivos</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Buscar" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Todo</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Estructuras de Datos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Archivos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Funciones</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>&apos;typedefs&apos;</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>&apos;defines&apos;</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Grupos</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Páginas</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Gestión de Memoria Física </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Autor</dt><dd>Erwin Meza Vega <a href="#" onclick="location.href='mai'+'lto:'+'eme'+'za'+'v@g'+'ma'+'il.'+'co'+'m'; return false;">emeza<span style="display: none;">.nosp@m.</span>v@gm<span style="display: none;">.nosp@m.</span>ail.c<span style="display: none;">.nosp@m.</span>om</a></dd></dl>
<h1><a class="anchor" id="project_start"></a>
Información del Proyecto</h1>
<p>En este proyecto se implementa la lógica para gestionar la memoria física, con un mapa de bits en el cual cada bit (unidad de asignación) referencia 4096 (4 KB) bytes de memoria (constante <a class="el" href="d5/df1/physmem_8h.html#abd03c49c90122f4dc22745979c5db642">MEMORY_UNIT_SIZE</a> en <a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>).</p>
<dl class="section user"><dt>Tamaño del Mapa de Bits</dt><dd></dd></dl>
<p>Si se tiene una memoria física (RAM) de 4 GB, el número de unidades sería: </p>
<pre class="fragment">    4GB / MEMORY_UNIT_SIZE = 4 GB / 4096 = 1048576 = 1 M de unidades.
</pre><p>Dado que un byte almacena 8 bits, el número de bytes requerido para todo el mapa de bits se obtiene al dividir el número de unidades entre 8: </p>
<pre class="fragment">   1 M / 8 = 131072 = 128 KB.   
</pre><p>En los ejemplos se usa un mapa de bits de este tamaño (128 KB), para soportar hasta 4 GB de memoria física.</p>
<p>El mapa de bits referenciado con el puntero memory_bitmap (<a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>) se configura en la dirección de memoria MMAP_LOCATION. Esta área de memoria se encuentra disponible, debido a que el kernel fue cargado por encima del límite de 1 MB.</p>
<p>La información de la memoria disponible se obtiene de la Estructura de Información Multiboot pasada por el GRUB al kernel (por medio del registro EBX en <a class="el" href="d4/dfb/start_8_s.html" title="Punto de entrada del kernel.">start.S</a> y luego en la variable global <a class="el" href="d9/d26/kernel_8c.html#a12fa0463bcd1fdbb93136dd2b4b7bc0b">multiboot_info_location</a> definida en el archivo <a class="el" href="d9/d26/kernel_8c.html" title="Código de inicialización del kernel en C. Este código recibe el control de start.S y continúa con la ...">kernel.c</a>.</p>
<p>El código principal del kernel en <a class="el" href="d9/d26/kernel_8c.html#ac81b272b403fb3e4a4c5c1cc389b4195" title="Función principal del kernel. Esta rutina recibe el control del codigo en ensamblador de start...">cmain()</a> invoca a la función <a class="el" href="d5/df1/physmem_8h.html#a8950a0a5d1ef2c64d6d99cbb29222803" title="Esta rutina inicializa el mapa de bits de memoria, a partir de la informacion obtenida del GRUB...">setup_memory()</a> (<a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>), la cual toma la variable global <a class="el" href="d9/d26/kernel_8c.html#a12fa0463bcd1fdbb93136dd2b4b7bc0b">multiboot_info_location</a> y obtiene la información del mapa de memoria construido por GRUB. Con este mapa de memoria inicializa el mapa de bits referenciado por la variable memory_bitmap.</p>
<p>El mapa de bits inicialmente se llena de ceros, para indicar todo el espacio de 4 GB como no disponible. Luego a partir de la información obtenida de GRUB se busca la región de memoria física que se encuentre por encima del kernel y de los módulos cargados, y que esté marcada por GRUB como disponible. Esta región de memoria se marca como memoria disponible dentro del mapa de bits ( los bits se establecen en 1).</p>
<p>El inicio de la región de memoria disponible se referencia con la variable global <a class="el" href="dd/dcb/physmem_8c.html#a6b0aa813ace82f29472b2a69ca8d26b1">allowed_free_start</a>. Esta variable permite realizar una validación al momento de liberar una unidad de memoria, ya que sólo se puede liberar una unidad que se encuentre por encima de <a class="el" href="dd/dcb/physmem_8c.html#a6b0aa813ace82f29472b2a69ca8d26b1">allowed_free_start</a>.</p>
<p>Adicionalmente se establece la variable global <a class="el" href="dd/dcb/physmem_8c.html#a0b8d77a6b1d35ac61aba798b812ef167">base_unit</a>, la cual almacena el número de la unidad de memoria que inicia en <a class="el" href="dd/dcb/physmem_8c.html#a6b0aa813ace82f29472b2a69ca8d26b1">allowed_free_start</a>.</p>
<p>La siguiente gráfica ilustra la configuración del mapa de bits en memoria:</p>
<pre class="fragment">      Mapa de Bits de la Memoria Física
 +-------------------------------+ Máximo (teórico) de la memoria (4 GB)
 |                        1048576| &lt;-- En un espacio de 4 GB existen 1048576
 |  Memoria no instalada         |     (1 M) unidades de 4 KB.
 +-------------------------------+
 |  ...                          |                                      
 |                               |     
 +-------------------------------+
 |  Memoria No instalada    X + 1| &lt;-- Unidades no disponibles, debido a que                                     
 |                               |     la memoria física es menor que 4 GB.                                                             
 +-------------------------------+ &lt;-- Fin de la memoria física disponible
 |  Memoria Disponible          X|  Se tienen X - N unidades de asignación
 |                               |  disponibles
 +-------------------------------+
 |  Memoria Disponible        ...| &lt;-- Unidades de asignación de 4 KB.
 |                               |
 +-------------------------------+
 |  Memoria Disponible        ...|
 |                               |
 +-------------------------------+
 |  Memoria Disponible          N| N = número de la primera unidad disponible
 |                               | &lt;-- base_unit = N
 +-------------------------------+ &lt;-- Inicio de la memoria física disponible
 |  Módulos cargados con el   ...|     (alllowed_free_start)
 |  Kernel                       |
 +-------------------------------+
 |  Datos del kernel          K+1|
 |                               |
 +-------------------------------+
 |  Código del kernel           K|
 |                               |
 +-------------------------------+ &lt;--- 0x100000 (1 MB)
 |                            ...|
 |                               |
 +-------------------------------+   - 
 |                            ...|   | Mapa de bits (máximo tamaño: 128 KB)
 |                               |   | Cada bit representa una región de 4 KB
 +-------------------------------+   | de memoria. Cada byte representa 32 KB  
 | 1 | 1 | 0 | 1 | 0 | 1 | 1 | 1 |   | de memoria.
 +-------------------------------+   - &lt;-- 0x500  = MMAP_LOCATION
 |                            ...|
 |                               |
 +-------------------------------+
 |                              1|
 |                               |
 +-------------------------------+
 |                              0|&lt;-- Número de la unidad de asignación.
 |                               |
 +-------------------------------+ Inicio de la memoria física</pre><dl class="section user"><dt>Asignación de Memoria</dt><dd></dd></dl>
<p>La asignación de memoria se puede realizar de dos formas:</p>
<ul>
<li>Asignar una unidad de memoria de 4 KB: Se recorre el mapa de bits buscando un bit que se encuentre en 1 (región disponible). A partir del desplazamiento del bit dentro del mapa de bits, se puede determinar la dirección física que le corresponde. Vea la función <a class="el" href="d5/df1/physmem_8h.html#afe29acb95fb642b1d6639f7d3593d201" title="Busca una unidad libre dentro del mapa de bits de memoria.">allocate_unit()</a> en el archivo <a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>.</li>
<li>Asignar una región de memoria de N bytes: Primero se redondea el tamaño solicitado a un múltiplo del tamaño de una unidad de asignación. Luego se busca dentro del mapa de bits un número consecutivo de bits que sumen la cantidad de memoria solicitada. Se retorna la dirección fisica que le corresponde al primer bit en el mapa de bits. Vea la función <a class="el" href="d5/df1/physmem_8h.html#aefa6e121afc225468bc3b136428552e6" title="Busca una región de memoria contigua libre dentro del mapa de bits de memoria.">allocate_unit_region()</a> en el archivo <a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>.</li>
</ul>
<dl class="section user"><dt>Liberado de Memoria</dt><dd></dd></dl>
<p>Se puede liberar memoria de dos formas:</p>
<ul>
<li>Liberar una unidad de memoria: Recibe como parámetro dirección de memoria. Si la dirección de memoria no se encuentra alineada al límite de una unidad de memoria, se toma como dirección el límite de unidad más cercano por debajo. A partir de la dirección de memoria, se obtiene el bit correspondiente en el mapa de bits, y se marca como disponible. Vea la función <a class="el" href="d5/df1/physmem_8h.html#a0764342c13c1a182cc07d732f3e5738c" title="Permite liberar una unidad de memoria.">free_unit()</a> en el archivo <a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>.</li>
<li>Liberar una región de memoria: Recibe como parámetro la dirección de inicio de la región y su tamaño. Si la dirección de inicio de la región no se encuentra alineada al límite de una unidad de memoria, se toma como dirección el límite de unidad más cercano por debajo. Luego, en el mapa de bits se marcan como disponibles los bits que corresponden a las unidades que conforman la región. Vea la función <a class="el" href="d5/df1/physmem_8h.html#ad37fdd7c43e1092a00fe53d8eca2a4f9" title="Permite liberar una región de memoria.">free_region()</a> en el archivo <a class="el" href="dd/dcb/physmem_8c.html" title="Contiene la implementacion de las rutinas relacionadas con las gestion de memoria fisica...">physmem.c</a>.</li>
</ul>
<dl class="section see"><dt>Ver también</dt><dd><a href="pages.html">Páginas relacionadas</a> </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generado por &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
